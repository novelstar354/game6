<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>音楽ゲーム</title>
 <link rel="icon" href="https://d2o4rrq92x9csx.cloudfront.net/articles/7-7-3-2.webp" sizes="16×16" type="image/png" />  
<style>
  html, body {margin:0; padding:0; width:100%; height:100%;}
  body {background:#111; color:#fff; font-family:sans-serif; overflow:hidden; display:flex; justify-content:center; align-items:center;}
  #game {position: relative; width:100%; max-width:480px; height:100%; display:flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #222 0%, #000 100%);}
  #noteArea {position: relative; width: 95%; height: 65%; border: 2px solid #555; background:#111; overflow:hidden; margin-top:20px; display:flex; justify-content: space-between; touch-action: none;}
  .lane {flex:1; border-left:1px solid rgba(255,255,255,0.2); border-right:1px solid rgba(255,255,255,0.2); position: relative; display:flex; flex-direction: column; justify-content: flex-end; align-items: center; transition: background 0.1s;}
  .lane span {position: absolute; bottom: 5px; color: rgba(255,255,255,0.3); font-size:calc(10px + 0.5vw); font-weight:bold;}
  .note {position: absolute; width: calc(15%); height: calc(5vh); border-radius: 10px; background: linear-gradient(45deg, #0ff, #0f0); box-shadow:0 0 10px #0ff; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#000; font-size:calc(12px + 0.5vw);}
  .holdNote {position:absolute; width: calc(15%); border-radius:10px; background: linear-gradient(45deg, #ff0, #fa0); box-shadow:0 0 10px #ff0;}
  #judgeLine {position: absolute; bottom: 10%; left:0; width:100%; height:5px; background:red; box-shadow:0 0 10px red;}
  #scoreBoard {margin-top:5px; font-size:calc(14px + 0.5vw); text-align:center;}
  .judgeText {position:absolute; font-size:calc(14px + 0.5vw); font-weight:bold; color:#fff; text-shadow:0 0 10px #fff; pointer-events:none;}
  #difficultySelect {position:absolute; top:2%; left:50%; transform:translateX(-50%); font-size:calc(12px + 0.5vw);}
  #difficultySelect button {margin:0 5px; padding:5px 10px; font-size:calc(12px + 0.5vw);}
  #resultScreen {position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); color:#fff; display:none; flex-direction: column; justify-content: center; align-items: center; font-size:calc(14px + 1vw);}
  #resultScreen button {margin-top:20px; padding:10px 20px; font-size:calc(12px + 0.5vw);}
  .activeLane {background: rgba(255,255,255,0.2);}
footer {
           padding: 30px;
           text-align: center;
           font-size: 0.85rem;
           color: rgba(255,255,255,0.5);
           border-top: 1px solid rgba(255,255,255,0.1);
           margin-top: 60px;
       }
</style>
</head>
<body>
<div id="game">
  <div id="difficultySelect">
    <button onclick="setDifficulty('easy')">Easy</button>
    <button onclick="setDifficulty('normal')">Normal</button>
    <button onclick="setDifficulty('hard')">Hard</button>
  </div>
  <div id="noteArea">
    <div class="lane" data-key="d"><span>D</span></div>
    <div class="lane" data-key="f"><span>F</span></div>
    <div class="lane" data-key="j"><span>J</span></div>
    <div class="lane" data-key="k"><span>K</span></div>
    <div id="judgeLine"></div>
  </div>
  <div id="scoreBoard">
    Score: <span id="score">0</span> | Combo: <span id="combo">0</span> | Max Combo: <span id="maxCombo">0</span>
  </div>
</div>
<div id="resultScreen">
  <div id="resultText"></div>
  <button onclick="location.reload()">Restart</button>
</div>
<audio id="bgm" src="your-song.mp3"></audio>
<audio id="bgmHard" src="your-fast-song.mp3"></audio>
<script>
const noteArea = document.getElementById('noteArea');
const lanes = Array.from(document.querySelectorAll('.lane'));
const scoreEl = document.getElementById('score');
const comboEl = document.getElementById('combo');
const maxComboEl = document.getElementById('maxCombo');
const resultScreen = document.getElementById('resultScreen');
const resultText = document.getElementById('resultText');
const bgm = document.getElementById('bgm');
const bgmHard = document.getElementById('bgmHard');

let score = 0, combo = 0, maxCombo = 0;
const notes = [], holdNotes = [], keyMap = ['d','f','j','k'];
let noteSpeed = 3;
let noteTiming = [];
let startTime = null;
let songDuration = 120;
const laneWidth = noteArea.clientWidth / 4;

function setDifficulty(level){
  notes.length = 0; holdNotes.length = 0; score=0; combo=0; maxCombo=0;
  scoreEl.textContent=score; comboEl.textContent=combo; maxComboEl.textContent=maxCombo;
  noteTiming=[]; startTime=null; bgm.pause(); bgmHard.pause();

  if(level==='easy'){ noteSpeed=2; songDuration=120; for(let i=1;i<=songDuration;i+=1) noteTiming.push({time:i,type:Math.random()<0.15?'hold':'tap'}); bgm.currentTime=0; bgm.play(); }
  else if(level==='normal'){ noteSpeed=3; songDuration=165; for(let i=1;i<=songDuration;i+=0.5) noteTiming.push({time:i,type:Math.random()<0.2?'hold':'tap'}); bgm.currentTime=0; bgm.play(); }
  else if(level==='hard'){ noteSpeed=4; songDuration=195; for(let i=1;i<=songDuration;i+=0.3) noteTiming.push({time:i,type:Math.random()<0.3?'hold':'tap'}); bgmHard.currentTime=0; bgmHard.play(); }

  requestAnimationFrame(gameLoop);
  setTimeout(showResult, songDuration*1000);
}

function spawnNote(lane,type='tap'){ if(type==='tap'){ const note=document.createElement('div'); note.className='note'; note.style.left=(lane*laneWidth+laneWidth/2-30)+'px'; note.style.top='0px'; note.dataset.lane=lane; note.dataset.type='tap'; noteArea.appendChild(note); notes.push(note); } else { const hold=document.createElement('div'); hold.className='holdNote'; hold.style.left=(lane*laneWidth+laneWidth/2-30)+'px'; hold.style.top='0px'; hold.style.height='120px'; hold.dataset.lane=lane; hold.dataset.type='hold'; noteArea.appendChild(hold); holdNotes.push(hold); } }

function gameLoop(timestamp){ if(!startTime) startTime=timestamp; const elapsed=(timestamp-startTime)/1000;
  for(let i=0;i<noteTiming.length;i++){ if(!noteTiming[i].spawned && elapsed>=noteTiming[i].time){ const lane=Math.floor(Math.random()*4); spawnNote(lane,noteTiming[i].type); noteTiming[i].spawned=true; } }
  for(let i=notes.length-1;i>=0;i--){ const note=notes[i]; note.style.top=(parseInt(note.style.top)+noteSpeed)+'px'; if(parseInt(note.style.top)>noteArea.clientHeight-80){ noteArea.removeChild(note); notes.splice(i,1); combo=0; comboEl.textContent=combo; } }
  for(let i=holdNotes.length-1;i>=0;i--){ const hold=holdNotes[i]; hold.style.top=(parseInt(hold.style.top)+noteSpeed)+'px'; if(parseInt(hold.style.top)>noteArea.clientHeight-80){ noteArea.removeChild(hold); holdNotes.splice(i,1); combo=0; comboEl.textContent=combo; } }
  requestAnimationFrame(gameLoop);
}

function showJudge(text,lane){ const judge=document.createElement('div'); judge.className='judgeText'; judge.textContent=text; judge.style.left=(lane*laneWidth+laneWidth/2-30)+'px'; judge.style.bottom='70px'; noteArea.appendChild(judge); setTimeout(()=>{noteArea.removeChild(judge);},500); }
function showResult(){ bgm.pause(); bgmHard.pause(); resultText.innerHTML=`Final Score: ${score}<br>Max Combo: ${maxCombo}`; resultScreen.style.display='flex'; }
function handleNoteHit(keyIndex){ lanes[keyIndex].classList.add('activeLane'); for(let i=0;i<notes.length;i++){ const note=notes[i]; if(parseInt(note.dataset.lane)===keyIndex){ const y=parseInt(note.style.top); const diff=Math.abs((noteArea.clientHeight-80)-y); if(diff<20){score+=100; combo+=1; maxCombo=Math.max(maxCombo,combo); scoreEl.textContent=score; comboEl.textContent=combo; maxComboEl.textContent=maxCombo; showJudge('Perfect',keyIndex); noteArea.removeChild(note); notes.splice(i,1); break; } else if(diff<40){score+=50; combo+=1; maxCombo=Math.max(maxCombo,combo); scoreEl.textContent=score; comboEl.textContent=combo; maxComboEl.textContent=maxCombo; showJudge('Good',keyIndex); noteArea.removeChild(note); notes.splice(i,1); break; } } } }
document.addEventListener('keydown',(e)=>{ const idx=keyMap.indexOf(e.key); if(idx!==-1) handleNoteHit(idx); });
document.addEventListener('keyup',(e)=>{ const idx=keyMap.indexOf(e.key); if(idx!==-1) lanes[idx].classList.remove('activeLane'); });
noteArea.addEventListener('touchstart',(e)=>{ for(const t of e.touches){ const rect=noteArea.getBoundingClientRect(); const x=t.clientX-rect.left; const laneIndex=Math.floor(x/laneWidth); handleNoteHit(laneIndex); } });
noteArea.addEventListener('touchend',(e)=>{ lanes.forEach(l=>l.classList.remove('activeLane')); });
</script>
</body>
</html>
